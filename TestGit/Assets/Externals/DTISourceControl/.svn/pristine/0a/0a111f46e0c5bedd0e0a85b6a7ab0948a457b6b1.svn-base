using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;

namespace DTI.SourceControl.ConsoleTools
{
	internal class RegexParser : IParser
	{
		private readonly List<IPattern> _patterns = new List<IPattern>();

		public RegexParser(params string[] patterns)
		{
			foreach (var pattern in patterns)
			{
				_patterns.Add(new RegexPattern(pattern));
			}
		}

		public string[] Patterns
		{
			set
			{
				_patterns.Clear();
				foreach (var pattern in value)
				{
					_patterns.Add(new RegexPattern(pattern));
				}
			}
		}

		public Result Parse(string log)
		{
		    var errorList = String.Empty;
		    var outResult = new List<String>();
			var lines = log.Split(new[] {Environment.NewLine}, StringSplitOptions.RemoveEmptyEntries);
            //TODO: Убрать эти логи перед коммитом!
		    UnityEngine.Debug.Log("LOG\n" + log);
			foreach (var line in lines)
			{
				Result result = null;
				foreach (var pattern in _patterns)
				{
					result = pattern.Match(line);
					if (result == null)
						continue;
				    if (!result.Succeeded)
				        errorList += result.ErrorMessage;
                    if(result.OutResult != null)
                        outResult.Add(result.OutResult.First());

				    break;
				}
				if (result == null)
					UnityEngine.Debug.LogWarning("Unparsed line: " + line);
			}
            if (!errorList.Equals(String.Empty))
		        return Result.Failure(errorList);
		    if (outResult.Count != 0)
		    {
		        var result = Result.Success();
                result.OutResult = outResult;
                return result;
		    }

			return Result.Ok;
		}
	}

	internal class RegexParser<T> : IParser<IEnumerable<T>> where T :class 
	{
		private readonly List<IPattern<T>> _patterns = new List<IPattern<T>>();

		public RegexParser(params string[] patterns)
		{
			foreach (var pattern in patterns)
			{
				_patterns.Add(new RegexPattern<T>(pattern));
			}
		}

		public string[] Patterns
		{
			set
			{
				_patterns.Clear();
				foreach (var pattern in value)
				{
					_patterns.Add(new RegexPattern<T>(pattern));
				}
			}
		}

		Result IParser.Parse(string log)
		{
			return Parse(log);
		}

		public Result<IEnumerable<T>> Parse(string log)
		{
			var results = new List<T>();

			var lines = log.Split(new[] { Environment.NewLine }, StringSplitOptions.RemoveEmptyEntries);
			foreach (var line in lines)
			{
				Result<T> result = null;
				foreach (var pattern in _patterns)
				{
					result = pattern.Match(line);
					if (result == null)
						continue;
					if (!result.Succeeded)
						return Result<IEnumerable<T>>.Failure(result.ErrorMessage);
					break;
				}
				if (result == null)
					UnityEngine.Debug.LogWarning("Unparsed line: " + line);
				else if (result.Value != null)
					results.Add(result.Value);
			}
			return Result<IEnumerable<T>>.Success(results);
		}
	}
}
